# 云成本优化脚本库

Azure 脚本

### 1.1 未挂载的磁盘
```bash
az disk list --query "[?managedBy==null].{name:name,rg:resourceGroup,size:diskSizeGb}" -o table
```

### 1.2 停机但仍占用资源的 VM

```bash
az vm list -d --query "[?powerState=='VM deallocated'].{name:name,rg:resourceGroup,publicIps:publicIps}" -o table
```

### 1.3 空后端的负载均衡
```bash 
az network lb address-pool list --lb-name <lb> -g <rg> -o json \
| jq '.[] | select(.backendIpConfigurations==null or (.backendIpConfigurations|length)==0)'

```
### 1.4 低 CPU 利用率的 VM
```bash 
az monitor metrics list \
  --resource <vmResourceId> \
  --metric "Percentage CPU" --interval P1D --aggregations Average \
  --start-time $(date -d "-30 days" -Ins) --end-time $(date -Ins)

```
### 1.5 成本导出并对比
```bash 
az costmanagement query -t ActualCost --timeframe MonthToDate \
 --dataset '{"granularity":"Daily","aggregation":{"cost":{"name":"PreTaxCost","function":"Sum"}},"grouping":[{"type":"Dimension","name":"ServiceName"},{"type":"Dimension","name":"TagName:app"}]}' \
 | jq -r '.properties.rows[] | @csv' > mtd.csv

```

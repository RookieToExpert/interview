# 数据传输服务 DTS：工作原理与完整流程

## 1) 定位
DTS（Data Transmission Service）用于数据库的结构迁移、全量迁移与增量同步，适合不停机/最小停机的上云、跨云、同城/异地容灾、双活等场景。

## 2) 网络接入方式
- 公网：源/目标有公网 IP，放通端口并将 DTS 的出口 IP 加入白名单。
- VPN/VPC 互通：两端通过 VPN 网关或打通 VPC 内网访问。
- 专线：通过专线连接 IDC/他云与百度云 VPC，适合高安全/大带宽。
- 同 VPC：源与目标均在百度云同一 VPC/对等连接内，直接内网访问。

> 以上任一方式满足连通后，目标既可以是 **云数据库 RDS**，也可以是 **BCC 上的自建数据库**。

## 3) 核心工作流程
1. **准备与评估**
   - 确认版本与引擎兼容、字符集/时区、主键/自增列、权限、网络连通性。
   - 评估迁移窗口、估计全量时长与增量追平延迟。

2. **创建任务**
   - 选择迁移类型：结构迁移 / 全量迁移 / 全量 + 增量。
   - 配置源库与目标库连接、对象选择（库/表/视图/函数）、并发与限速、DDL 处理策略、冲突处理策略。

3. **结构迁移**
   - 在目标端自动创建库表/索引/权限等对象（可选择跳过或自建）。

4. **全量迁移**
   - 并行抽取源库数据，批量写入目标库。
   - 可设置带宽/TPS 限速，避免压垮源与目标。

5. **增量同步（CDC）**
   - 从源库增量日志（如 binlog/redo）实时抽取变更，按表/主键分片并行回放到目标库。
   - 支持断点续传、重试与延迟监控。

6. **一致性校验**
   - 全量完成且增量追平后，抽样/分批对账（记录数、校验和、采样比对等）。

7. **业务割接**
   - 在割接窗口停写源库或进入只读，等待增量“追平 0”。
   - 切换应用连接串到目标库，观测一段时间确认稳定。

8. **收尾与回退预案**
   - 观察期结束后停止 DTS 任务。
   - 如需回退，可按需要创建反向同步任务，或保留源库一段时间作为兜底。

## 4) 常见拓扑
- **IDC/他云 DB →（公网/VPN/专线）→ DTS → 百度云 RDS**
- **IDC/他云 DB →（公网/VPN/专线）→ DTS → BCC 自建 DB**
- **百度云 VPC 内 DB ↔ DTS ↔ 同/异地域 RDS（容灾/双活）**

## 5) 关键参数与实践
- **并发/限速**：控制抽取/写入并发、带宽与 TPS。
- **对象过滤**：选择库表、忽略临时/归档表，避免无关数据。
- **DDL 处理**：Online DDL（如 gh-ost/pt-osc）与日志回放的兼容策略。
- **冲突策略**：主键/唯一键冲突跳过、覆盖或失败。
- **监控告警**：延迟、错误率、重试次数；异常及时告警。
- **安全**：最小权限账号、传输链路加密、白名单管控。

## 6) 一句话总结
DTS = 结构迁移 + 全量搬迁 + 增量 CDC + 校验 + 平滑割接；  
网络方式灵活（公网/VPN/专线/同 VPC），目标既可用 RDS，也可用 BCC 自建库。

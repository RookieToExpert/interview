#### 口述版本：
在之前支持的一个客户项目中，他们的生产环境运行在本地 VMware vSphere 上，共 13 台虚拟机，覆盖前端、核心交易、推荐引擎、域控、NAT 防火墙以及 MySQL 主从数据库。
在风险评估中，我们发现了两大问题：第一，机房存在明显单点风险，比如 NAT 防火墙宕机会导致所有出站流量中断；第二，关键服务和数据库缺乏二级保护，硬件一旦故障，恢复时间过长，业务 SLA 无法满足。尤其是数据库，如果主从同步中断或磁盘损坏，恢复复杂且风险极高。
基于这些痛点，我们设计了 基于 Azure Site Recovery 的跨区域容灾方案。在 East US 部署 Recovery Vault，制定复制与保护策略，将 RPO 控制在 30 分钟以内，并启用 App-consistent 快照，每小时生成一次、保留 5 天。MySQL 在灾备区不是一比一复刻主从，而是保留一个可随时拉起的主库 VM，结合 binlog 校验和快照一致性，确保 failover 后数据完整可靠。
在网络层，我们构建了与本地逻辑拓扑一致的 VNet、子网和 NSG，采用 ExpressRoute Active/Passive 模式，并结合 DNS 自动切换，将 TTL 调低至 60 秒以内。为了避免目录服务断点，我们在目标区域提前部署了辅助域控，并保持持续同步，确保切换过程中认证和解析不会中断。
在安全和治理上，我们坚持最小权限原则，单独配置 VMware 服务账号，并引入全程日志审计。在应用层推动统一通过域名访问服务，而非绑定 IP，保证 failover 后无需人工改配置。
在演练阶段，我们设计了多轮故障注入和计划切换，验证了交易 API、前端、推荐引擎和 MySQL 的全链路能在 30 分钟 RPO、1 小时 RTO 内恢复。最终，客户的系统 SLA 从 99.5% 提升到 99.95%，实现了从“可恢复”到“可持续运行”的跨越。
当然，在实施过程中我们也遇到过挑战：比如 MySQL 最初只能生成 crash-consistent 快照，我们通过 VSS 服务启用和 binlog 校验实现了多层次一致性；DNS/AD 最初未同步导致认证失败，我们设计了跨区目录复制和分层 DNS 策略；Mobility Agent 在部分老旧 VM 上兼容性差，我们采用差异化部署和基线监控；在回切时发现双主写入风险，我们建立了严格的回切治理流程，确保不会产生数据分叉。
通过逐一解决这些问题，我们把容灾从单纯的技术保护，提升为 完整的业务连续性治理体系，真正让客户的核心交易业务具备跨区域的韧性和稳定性。

#### 详细版本：
在之前支持的一家客户中，他们的生产环境主要运行在本地 VMware vSphere 上，总共有 13 台虚拟机，覆盖前端、核心交易、推荐引擎、域控 DNS、防火墙以及数据库等关键模块。数据库采用的是 本地部署的 MySQL 主从架构，承载交易、订单和库存等核心数据。
在风险评估阶段，我们发现了两大隐患：
第一，本地机房存在明显的 单点风险，例如 NAT 防火墙 VM 宕机后，所有出站流量和外部支付接口都会中断；
第二，计算和存储缺乏二级保护，像 API 服务、推荐引擎和数据库这类关键业务，如果底层硬件故障，恢复速度非常慢，客户的 SLA 难以满足。尤其数据库层，如果主从同步出现中断或磁盘损坏，恢复复杂且业务影响严重。
基于这些风险，我们设计了基于 Azure Site Recovery（ASR） 的跨区域容灾方案。在 Azure East US 部署 Recovery Services Vault，统一进行复制与恢复管理，定义保护组和复制策略，将 RPO 控制在 30 分钟以内，并启用 App-consistent 快照，确保包括 MySQL 在内的业务数据一致性，每小时生成一次快照，保留 5 天，支持任意时间点恢复。本地是主从模式，但在灾备区我们不是 1:1 搭建双节点，而是保留了一个“可随时拉起的主库 VM”。这样在 failover 时，应用可以直接连这台数据库。如果客户要求在灾备区也维持主从，我们可以用 ASR 同步两台 VM，并在切换演练时验证复制链路。但多数情况下，灾备只需要一台最新副本就够。数据一致性依赖 ASR 的 App-consistent snapshot 以及 binlog 同步机制，我们还做过演练，验证事务在 failover 后没有丢失。数据一致性我们是通过三方面来保证的：第一，ASR 的 App-consistent snapshot 可以在快照前冻结 I/O，确保数据文件和 binlog 是一致的；第二，我们在灾备区拉起 MySQL 后做 binlog 校验，确认事务链路完整；第三，在演练里通过模拟真实交易，验证 failover 后的数据和本地主库一致，没有丢单或者重复写入的情况。
在网络与架构层面，我们为客户在目标区域搭建了与本地一致的 VNet、子网和 NSG，保证网络拓扑一致性，确保切换时前后端服务、推荐引擎和 MySQL 数据库都能保持原有通信逻辑。为降低网络切换风险，我们采用了 ExpressRoute Active/Passive 模式，并结合 DNS 自动切换策略，将解析 TTL 提前调低至 60 秒以内，从而在主站点故障时，东美区域能够快速接管业务。难点在于 DNS 与 AD 的一致性，因此我们在目标区域提前部署了辅助域控节点，并保持目录服务同步，避免切换过程中出现认证失败或解析延迟的问题。
在 数据库层，我们除了依赖 ASR 的复制与快照外，还额外配置了 MySQL 主从延迟监控，在演练时验证 failover 后数据库数据一致性与可用性。这样即便主机房宕机，业务也能在新的区域快速接入数据库，避免因数据回退或事务丢失导致的业务异常。
在安全与治理方面，我们采用最小权限原则，创建了专用 VMware 服务账号，并对 ASR 复制与容灾演练全过程启用了日志审计，确保操作可追溯。在应用层，我们推动业务统一通过 域名访问 MySQL 与 API 服务，而不是绑定固定 IP，从而保证切换后无需修改连接配置。
最后，在交付前我们组织了多轮容灾演练，包括计划内故障注入和突发故障模拟。在演练中，从触发切换到业务恢复上线，我们验证了交易 API、前端展示、推荐引擎以及 MySQL 数据库的全链路均能在 30 分钟 RPO、1 小时 RTO 内恢复，并且未出现连接字符串或认证失效的问题。
通过这一升级，客户的整体业务连续性显著提升，从原本依赖单点机房，升级到具备跨区域灾备能力，系统可用性 SLA 从 99.5% 提升到 99.95%，为核心交易业务提供了更强的稳定性保障。

问题：

在项目实施过程中，我们确实遇到了一些典型挑战，这些问题也正是大规模生产级容灾架构需要重点解决的痛点。

第一，应用一致性快照失败问题。
在早期演练中发现，部分 MySQL 节点只能生成 crash-consistent 快照，原因是底层 VSS 服务未启用或数据库插件未正确加载。这类快照虽然能保证磁盘级别一致性，但无法满足事务级数据恢复需求。针对这一点，我们引入了 多层次一致性保障机制：在操作系统层确保 VSS 服务全量启用，同时为 MySQL 配置应用感知插件，并结合 binlog 校验。在后续演练中，我们通过双重校验（快照一致性 + 事务日志回放）来确保数据库恢复到业务可用状态，而不是仅停留在文件一致性。
第二，AD 与 DNS 的跨区一致性问题。
在第一次 Failover 后，部分用户出现认证失败，原因在于目标区域的域控并未与主站点完全同步，而 DNS 切换时，部分分支机构仍然解析到旧的 DC 地址。针对这一挑战，我们设计了 跨区目录服务复制与分层 DNS 策略：在灾备区预部署只读域控节点（RODC），保持与主目录服务持续同步；在 DNS 层通过调整 TTL 与分级解析策略，确保在切换时新域控节点能被快速感知。通过这种方式，我们把目录服务的可用性从“单点容灾”提升到了“全局弹性”。
第三，Mobility Agent 的兼容性与资源占用问题。
在部分老旧 VM 上，Mobility Agent 出现安装失败或资源占用过高，影响了复制性能。为此，我们建立了差异化部署策略：对资源敏感型 VM 采用轻量级快照代理，核心业务 VM 则通过独立资源池承载复制开销；同时在项目初期建立了 Agent 健康度基线，在上线前通过监控确保所有代理处于健康状态，从而避免了大规模 failover 时的隐患。
第四，源站恢复后的双主写入冲突问题。
在一次回切测试中，我们发现主站恢复与灾备站点并行运行时，可能出现双主写入冲突。为避免数据分叉，我们制定了 严格的回切治理流程：包括只允许单主写入、先行冻结业务写流量、完成差异数据合并后再切回主站。并且在数据库层引入了 binlog 校验和冲突检测机制，确保任何潜在冲突都能在业务恢复前被消解。
通过解决这些挑战，我们不仅保障了 RPO 在 30 分钟内、RTO 在 1 小时内的指标落地，更把容灾从“技术演练”提升到了“业务连续性治理”。最终，客户从只能依赖单点机房，升级到具备跨区域、多层次一致性保障的容灾架构，实现了从 可恢复 到 可持续运行 的质的飞跃。


## 背景

客户当前共计部署 13 台 VM，全部运行在 本地 VMware vSphere 环境 中，包括：

前端服务（3 台）：部署 Nginx + React SSR，负责用户页面展示与首屏加载；

API 服务与订单处理（6 台）：负责核心交易、库存验证、支付对接等；

推荐引擎（4 台）：部署 TensorFlow Serving，提供商品个性化推荐；客户希望通过ASR将VM同步到SouthEast Asia。

DNS + AD（2 台）：Windows Server 作为域控 & DNS，常为 DC01、DC02

NAT + 防火墙（1 台）：Linux-based NAT VM，负责出站流量 & DNAT 映射（如 jumpbox、外部服务）

后端数据库为 Azure Database for PostgreSQL（Flexible Server），已在云端运行，不纳入 VM 迁移范围。

## 实施细节
在 East US 区域创建 Recovery Services Vault，作为 ASR 数据接收与恢复管理的控制中心；启用跨区域存储备份与复制策略，创建保护组和复制策略，设置：
RPO 阈值为 30 分钟；
启用 App-consistent snapshots，每 1 小时生成一次；
保留时间为 5 天（根据客户希望恢复至过去五天内任意时间点的要求）；绑定目标 region 为 East US。
协助客户根据本地 VMware 网络拓扑，在 East US 创建对应的 VNet、子网、NSG；保证子网划分与服务间的网络通信逻辑一致，为未来故障转移后提供无缝连接。

<img width="1012" height="380" alt="image" src="https://github.com/user-attachments/assets/9e0c3a39-a166-4cee-a7a2-7d81c4d05b95" />

<img width="958" height="312" alt="image" src="https://github.com/user-attachments/assets/6aaf7754-5460-4a2d-857f-9e17699b250f" />


创建一个具有必要权限的本地 VMware 帐号（可访问 vCenter、ESXi host），用于检测与操作 VM（关机、迁移、创建磁盘快照等）；配置本地 VMware 资源组与 datacenter 授权连接；在所有需要保护的本地 VM 上安装并注册 ASR Mobility Agent；

在 Recovery Vault 中注册本地 VMware 环境，部署 ASR Configuration Server；配置本地与 Azure East US 的 ExpressRoute（Active/Passive 模式）；验证目标服务在 DR 区域中可与 Azure 数据库、CDN 服务及其他 Azure 资源正常通信；部署 DNS 自动切换策略用于未来快速恢复。

帮助配置本地ExpressRoute与两个Azure区域的连接(Active/Passive模式)，确保主区域故障后，目标区域的服务可无缝与本地系统通信。

## 问题
由于客户设备上安装有 Symantec Antivirus 软件，需将 Mobility Agent 的路径添加至 exclusion list，避免拦截造成安装/运行失败。
到云端机器和AD通信有问题，脱域。
vCenter账号权限不足。
VSS writer的问题。
replicate时发生的网络问题。





## 项目经历
#### 项目一

![alt text](image-5.png)

问题：

![alt text](image-6.png)

1. **该项目的客户是制造业，其业务特点对迁移有哪些特殊要求？你如何针对性设计迁移方案？**
> 问题：缺少 “测试迁移的具体维度”“数据安全保障措施”“方案落地成效” 等关键环节，难以体现工作闭环。
- **痛点：**
    - 实时性
        - 本地 PLC、传感器等设备产生的数据流需实时同步至业务系统指导生产，要求端到端延迟控制在毫秒级，且数据传输零丢包、低延迟，避免影响生产调度；
    - 高可用约束，停机窗口要求毫秒级
        - 生产线 24 小时连续运行，对 RPO（恢复点目标）要求达分钟级，极端场景下需秒级，迁移割接的业务中断窗口必须极小，防止生产线停摆；
    - 部分服务器因版本，特殊协议及数据合规原因，需保留至本地：
        - 部分核心数据需满足本地合规留存要求，且老旧设备仅支持 Modbus 等传统工业协议或旧版 SDK，无法直接上云，需保障本地设备与云端系统的低延迟通信。”
- **定义分工：**
    明确区分架构师团队与自身团队的职责，架构师负责前期的迁移规划，包括排期方案、迁移顺序、回滚方案和云上landing等，与客户协商完成。自身团队主要聚焦于搭建复制链路，制定技术方案和实施，确保迁移过程的技术可行性和高效执行。
- **迁移线路搭建：**
    - 采用Azure Migrate进行迁移，区分物理机、Hyper-V和VMware虚拟机，采用不同的迁移策略和工具。
    - 物理机通过agent-based方式迁移，Hyper-V和VMware通过agentless方式迁移：
        - 虚拟机（VMware/Hyper-V）：采用无代理（agentless）迁移，通过 VMware CBT（变更块跟踪）技术、Hyper-V HRL 日志追踪，在 hypervisor 层捕获 Guest VM 的数据变化，结合快照机制实现增量备份，无需在原机器安装组件，避免干扰生产；​
        - 物理机：批量部署轻量迁移代理，通过 9443 端口（原表述 “943 端口” 修正）与本地迁移服务器通信，实时采集磁盘数据，适配物理机的异构环境需求。
    - 建立appliance迁移服务器，确保迁移服务器可以与源服务器通过9443端口通信：
        - control plane：将源服务器的元数据通过迁移服务器走公网迁移至云端。
        - data plane：将源服务器的数据通过迁移服务器走专线迁移至云端。
        - 我们在客户本地部署 Microsoft Migration Appliance（迁移服务器）作为中转枢纽：先归集本地全量 / 增量数据，再通过 443 加密端口、专线传输至云端对象存储（Storage Account），最后由云端replica disk，确保传输安全与低延迟。
    - 通过ansible脚本批量安装迁移代理到物理服务器上，减少人工操作。
    - 通过Azure Migrate的工具，评估迁移服务器的兼容性，性能和带宽需求。配置对应的带宽策略，错峰复制，不占用业务高峰期的带宽。
    - 进行初始全量复制和增量复制，通过bitmap及checksum的对比，确保数据一致性。
    - 进行影子测试，确保迁移后的服务器可以正常启动和运行。期间会进行金丝雀测试，确保部分服务器在云端可以正常工作。
    - 正式割接阶段，进行最终的增量复制，确保数据的最新性。进行DNS切换，确保用户可以访问云端的服务器。

2. **项目周期仅 2 个月，如何在短时间内完成 300+VM 的评估和迁移？时间管理上有哪些技巧？**
> 兼容性提前排错、依赖分组迁移、测试问题前置，评估期→执行期→测试期→割接期
首先我可能要澄清一下就是，嗯，并不是说整个周期就是在两个月内完成，其实是我们负责的这一部分集群大概是在两个月完成，但是还有其他团队的小伙伴负责，可能周期要翻倍，就是可能4个月。但是我们具体的周期还是不清楚，因为我们完成这一趴之后，这个案例就结束了，后续就不归我们对接。

那但是从时间维度的考虑，那我们肯定还是有非常多方式可以去避免这个迁移周期会拉长：
1. 批量兼容性排错
第一个是在评估源机器的时候，通过Azure Migrate的assessment工具去识别机器的兼容性问题的报告，这个报告会产生包括操作系统，磁盘，security boot等等的一系列兼容性检查，比如当时我们查到有数台windows VM 2008系统版本不兼容，我们需要在复制链路的提前三天要完成系统升级适配，避免之后迁移因版本问题导致重新传输数据而导致迁移排期拉长。
2. 依赖分组迁移
除了评估兼容性以外，我们还会通过assessment工具得到一组依赖关系图，可以看到每台机器暴露了哪些端口，运行了哪些服务，安装了哪些软件，通过这些信息，我们会去分析它们之间的依赖关系从而知道有些机器是强关联的，可能你这一台机器迁过去，它依赖的另外一台机器还没有迁过去，那么它就会导致后续测试迁移无法正常进行。那么我们通过这个依赖关系图，我们就可以把它们进行分组，确保强关联的机器是成组一起迁移的。那这样的话就会大大降低了之后测试迁移无法正常进行的情况。
3. 带宽控制 
在正式执行复制的时候，我们也会根据这一组的服务器的数据量，去按批次的去进行数据复制，避免占用过多生产环境的带宽，导致影响业务的正常运行。同时也会在云端创建多个对象存储的接收点，那这样的话也会避免因为单个对象存储的带宽限制导致复制失败，进一步拉长迁移周期。
4. 测试问题前置
那么在测试迁移阶段，我们也要确保每台机器能够正常开机和运行，确保这里出现的所有问题都要解决，避免正式迁移的时候出现问题，导致迁移排期拉长。包括我们当时发现有部分exchange server的服务器出现蓝屏的情况，后面发现azure vm对exchange server有一些特定要求，我们需要去exchange server的源机器上先暂时停止exchange server的服务，然后再去进行测试迁移，才能确保它能正常开机，后续再将exchange server的服务启动。这一步我们就需要确保在测试迁移阶段就要发现并解决，避免正式迁移的时候出现问题，导致迁移排期拉长。

3. 制造业客户的 “高峰时段线性拓展” 需求，在 Azure 中如何实现？你选择了哪些 Azure 服务支撑该需求？

4. 项目中 SLO、RTO、RPO 的具体指标是什么？如何通过技术方案保障这些指标的达成？
> 规范指标界定，补全认知闭环.深化技术方案，明确 “指标→手段→验证” 逻辑
关于具体的SLO, SLA, SLI这些指标，因为这是在迁移前售前团队和业务团队谈合同的时候就达成了一致，但我们团队没有接触到这些具体的合同细节，但对于这些指标类型还是都理解的。
2. RPO 指标：
和容灾不一样，迁移对RPO的指标并没有那么严格，我们迁移的工具是根据一个公式去动态调整RPO的间隔的，可能会在6到12个小时之间浮动，具体的RPO间隔是根据上一次增量备份的时间减半去计算下一次增量备份的时间间隔，所以这个RPO其实并不是一个固定值，可能会在6到12个小时之间浮动。这一步的设计也是有原因的，就是因为你频繁的去做增量备份，可能会影响生产环境的稳定性，同时也会增加费用。其次就还是因为迁移它就是一个一次性的动作，并不是长期的容灾备份，所以对RPO的指标要求并不严格。
3. RTO 指标：
客户更在意的是RTO的指标，客户要求的是分钟级甚至极端情况下秒级的RTO指标。那其实这个RTO指标更多的是强调整体架构的方案迁移的要求，针对我们迁移的这一部分，其实并不是会直接影响他们生产环境的工厂流水线和应用，所以针对我们负责的部分，RTO的指标相对宽松很多。但是据我了解，针对到工厂流水线和应用的部分，是有专门的架构师和实施专家去对接，他们主要采用的方法还是分批次迁移，先迁移无状态的应用，包括一些静态网页，针对这部分，会保持一个阶段性双活的状态，本地应用还在正常运行，通过金丝雀的方式，部分放流到云端，测试云端服务器是否能正常运行，然后再针对核心数据库去进行迁移，这一部分因为核心数据库的RPO是严格的五分钟，所以最后数据同步的数据量并不会很大，进一步压缩了RTO的时间，控制在分钟级的效果。


5. 变更窗口有限且迁移窗口要求 <=30 分钟，你采取了哪些技术手段缩短迁移时间？

![alt text](image-7.png)

6. Azure Migrate 的评估流程是怎样的？你如何通过其实现准确的容量和依赖评估？

7. 推荐 VM SKU 时，D 系列和 F 系列的适用场景有什么区别？你基于哪些因素做出推荐？

8. 判断矩阵中 “可直接上云 / 需改造 / 替换为 PaaS” 的标准是什么？举一个将应用替换为 PaaS 服务的案例，带来了哪些优势？

![alt text](image-8.png)

1. 解释一下 VMware 的 CBT 技术和 Hyper-V 的 HRL 日志传输的原理，它们在数据迁移中有哪些优势？

2. ExpressRoute 和 private endpoint 如何保障数据传输的安全性？配置过程中需要注意哪些网络配置细节？

3. 若私网传输过程中出现带宽瓶颈，你如何排查和解决？

![alt text](image-9.png)

1. 网络方面的 landing 建议具体有哪些？比如 VNet 设计、子网划分、安全组配置等。

2. 针对该项目的应用特点，你推荐了哪些监控工具和指标？如何确保监控体系在上线后立即生效？

3. 密钥存储使用了 Azure 的哪些服务？如何配置密钥的访问权限和轮换策略？

![alt text](image-10.png)

1. 测试迁移的次数和每次的重点是什么？如何设计隔离测试 VNet 的环境，确保与生产环境的一致性？

2. 性能验证中关注了哪些指标？比如 CPU、内存、磁盘 IO、网络延迟等，如何优化不达标项？

3. 迭代调整 VM 规格和磁盘时，依据什么标准？调整后如何验证优化效果？

![alt text](image-11.png)

1. 如何划分低风险和高风险的 VM？replication group 的分组依据是什么？

2. 批次迁移的具体流程是怎样的？如何协调客户配合每个批次的迁移窗口？

3. 源端只读的配置方式是什么？若需要回滚，回滚流程和时间预期是怎样的？